<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLO2024</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .search-bar input[type="text"] {
            width: 300px;
            padding: 10px;
            font-size: 16px;
            margin-right: 10px;
        }

        .search-bar button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }

        .search-bar button:hover {
            background-color: #0056b3;
        }

        .group-list {
            list-style-type: none;
            padding: 0;
        }

        .group-item {
            margin-bottom: 20px;
        }

        .group-item h3 {
            margin: 0;
            padding: 10px;
            background-color: #333;
            color: #fff;
        }

        .group-item ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .group-item li {
            padding: 10px;
            background-color: #fff;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-item li.checked-in {
            background-color: #d4edda;
        }

        .group-item label {
            cursor: pointer;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

    <h1>VLO2024</h1>

    <!-- Search Bar -->
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search for group or individual...">
        <button id="clearSearchBtn">Clear</button>
    </div>

    <!-- Group List -->
    <div id="groupList" class="group-list">
        <!-- JavaScript will dynamically generate group items here -->
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const groupList = document.getElementById("groupList");
        let currentSearchQuery = ''; // To store the current search query

        // Function to display groups
        function displayGroups(groups) {
            groupList.innerHTML = ''; // Clear previous groups
            groups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.classList.add('group-item');
                
                const groupHeader = document.createElement('div');
                groupHeader.classList.add('group-header');
                groupHeader.innerHTML = `
                    <h3>${group.groupName}</h3>
                    <label>
                        <input type="checkbox" class="group-checkbox" ${group.users.every(u => u.checkedIn) ? 'checked' : ''}> Check-in all
                    </label>
                `;

                const userList = document.createElement('ul');
                group.users.forEach(user => {
                    const li = document.createElement('li');
                    li.classList.toggle('checked-in', user.checkedIn); // Add checked-in class if true
                    li.innerHTML = `
                        <label for="${user.username}">
                            <input type="checkbox" id="${user.username}" class="check-in-checkbox" ${user.checkedIn ? 'checked' : ''}>
                            ${user.username}
                        </label>
                    `;

                    const checkbox = li.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function () {
                        socket.emit('checkInUser', {
                            username: user.username,
                            checkedIn: this.checked
                        });
                    });

                    userList.appendChild(li);
                });

                groupHeader.querySelector('.group-checkbox').addEventListener('change', function () {
                    socket.emit('checkInGroup', {
                        groupName: group.groupName,
                        checkedIn: this.checked
                    });
                });

                groupItem.appendChild(groupHeader);
                groupItem.appendChild(userList);
                groupList.appendChild(groupItem);
            });

            // After displaying, apply the current search filter
            filterGroups(currentSearchQuery);
        }

        // Function to filter groups and users based on search query
        function filterGroups(searchQuery) {
            currentSearchQuery = searchQuery.toLowerCase(); // Store current search query
            const groupItems = Array.from(document.querySelectorAll('.group-item'));

            groupItems.forEach(groupItem => {
                const groupName = groupItem.querySelector('h3').textContent.toLowerCase();
                const userListItems = Array.from(groupItem.querySelectorAll('li'));

                // Filter users within the group based on search query
                let userMatches = false;
                userListItems.forEach(li => {
                    const username = li.querySelector('label').textContent.toLowerCase();
                    if (username.includes(currentSearchQuery)) {
                        li.style.display = ''; // Show the user
                        userMatches = true;
                    } else {
                        li.style.display = 'none'; // Hide the user
                    }
                });

                // Show the entire group if the group name matches the search query
                if (groupName.includes(currentSearchQuery)) {
                    groupItem.style.display = '';  // Show group
                    userListItems.forEach(li => li.style.display = '');  // Show all users in the group
                } else if (userMatches) {
                    groupItem.style.display = '';  // Show group but filtered users
                } else {
                    groupItem.style.display = 'none';  // Hide the group
                }
            });
        }

        // Function to clear the search and reset the list
        function clearSearch() {
            searchInput.value = ''; // Clear the search input field
            currentSearchQuery = ''; // Reset the search query
            filterGroups(''); // Reset the group and user visibility
        }

        // Receive updated groups from the server
        socket.on('loadGroups', (groups) => {
            displayGroups(groups); // Display groups and maintain search filter
        });

        // Handle search input (handles both groups and users)
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener('input', function () {
            filterGroups(searchInput.value); // Apply search filter when typing
        });

        // Handle clear button click
        const clearSearchBtn = document.getElementById("clearSearchBtn");
        clearSearchBtn.addEventListener('click', clearSearch);

    </script>

</body>
</html>

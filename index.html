<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Check-In</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input[type="text"] {
            width: 300px;
            padding: 10px;
            font-size: 16px;
        }

        .group-list {
            list-style-type: none;
            padding: 0;
        }

        .group-item {
            margin-bottom: 20px;
        }

        .group-item h3 {
            margin: 0;
            padding: 10px;
            background-color: #333;
            color: #fff;
        }

        .group-item ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .group-item li {
            padding: 10px;
            background-color: #fff;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-item li.checked-in {
            background-color: #d4edda;
        }

        .group-item label {
            cursor: pointer;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

    <h1>Event Check-In</h1>

    <!-- Search Bar -->
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search for group or individual...">
    </div>

    <!-- Group List -->
    <div id="groupList" class="group-list">
        <!-- JavaScript will dynamically generate group items here -->
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const groupList = document.getElementById("groupList");

        // Function to display groups
        function displayGroups(groups) {
            groupList.innerHTML = ''; // Clear previous groups
            groups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.classList.add('group-item');
                
                const groupHeader = document.createElement('div');
                groupHeader.classList.add('group-header');
                groupHeader.innerHTML = `
                    <h3>${group.groupName}</h3>
                    <label>
                        <input type="checkbox" class="group-checkbox"> Check-in all
                    </label>
                `;

                const userList = document.createElement('ul');
                group.users.forEach(user => {
                    const li = document.createElement('li');
                    li.classList.toggle('checked-in', user.checkedIn); // Add checked-in class if true
                    li.innerHTML = `
                        <label for="${user.username}">
                            <input type="checkbox" id="${user.username}" class="check-in-checkbox" ${user.checkedIn ? 'checked' : ''}>
                            ${user.username}
                        </label>
                    `;

                    const checkbox = li.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function () {
                        socket.emit('checkInUser', {
                            username: user.username,
                            checkedIn: this.checked
                        });
                    });

                    userList.appendChild(li);
                });

                groupHeader.querySelector('.group-checkbox').addEventListener('change', function () {
                    socket.emit('checkInGroup', {
                        groupName: group.groupName,
                        checkedIn: this.checked
                    });
                });

                groupItem.appendChild(groupHeader);
                groupItem.appendChild(userList);
                groupList.appendChild(groupItem);
            });
        }

        // Receive updated groups from the server
        socket.on('loadGroups', (groups) => {
            displayGroups(groups);
        });

        // Search function (handles both groups and users)
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener('input', function () {
            const searchQuery = searchInput.value.toLowerCase();
            const groupItems = Array.from(document.querySelectorAll('.group-item'));

            groupItems.forEach(groupItem => {
                const groupName = groupItem.querySelector('h3').textContent.toLowerCase();
                const userListItems = Array.from(groupItem.querySelectorAll('li'));

                // Filter users within the group based on search query
                let userMatches = false;
                userListItems.forEach(li => {
                    const username = li.querySelector('label').textContent.toLowerCase();
                    if (username.includes(searchQuery)) {
                        li.style.display = ''; // Show the user
                        userMatches = true;
                    } else {
                        li.style.display = 'none'; // Hide the user
                    }
                });

                // Show group if either the group name or any user within matches the search
                if (groupName.includes(searchQuery) || userMatches) {
                    groupItem.style.display = '';
                } else {
                    groupItem.style.display = 'none';
                }
            });
        });
    </script>

</body>
</html>
